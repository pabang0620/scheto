# Database Migration Strategy for Enhanced Schedule Auto-Generation

## Overview
This migration adds advanced scheduling capabilities to the existing scheduleAuto application, including shift patterns, schedule templates, employee constraints, and generation logging.

## Migration Approach

### 1. Safe Migration Strategy
- **Additive Changes Only**: All changes are additive to preserve existing data
- **Default Values**: All new fields have appropriate default values
- **Nullable Fields**: Optional fields are nullable to prevent data constraints
- **Backward Compatibility**: Existing functionality will continue to work

### 2. Schema Changes Summary

#### Enhanced Existing Models

**Employee Model**:
- Added `weeklyHoursTarget` (default: 40)
- Added `maxDailyHours` (default: 8)
- Added `minDailyHours` (default: 4)
- Added `maxConsecutiveDays` (default: 5)
- Added `minRestHours` (default: 12)
- Added `isActive` (default: true)
- Added `employeeType` (default: "full-time")
- Added `seniorityLevel` (default: "junior")

**Company Model**:
- Added `timezone` (default: "UTC")
- Added `operatingHours` (nullable JSON)
- Added `peakHours` (nullable JSON)
- Added `holidaySchedule` (nullable JSON)
- Added `autoSchedulingEnabled` (default: false)
- Added `scheduleNotificationDays` (default: 7)
- Added `allowEmployeeSelfScheduling` (default: false)
- Added `maxAdvanceScheduleDays` (default: 30)
- Added `minimumStaffCoverage` (default: 1.0)
- Added `overtimePolicy` (nullable JSON)
- Added `unionRules` (nullable JSON)
- Added `complianceRequirements` (nullable JSON)

**Schedule Model**:
- Added `shiftPatternId` (nullable foreign key)
- Added `generationLogId` (nullable foreign key)
- Added `isAutoGenerated` (default: false)
- Added `priority` (default: "normal")
- Added `estimatedWorkload` (nullable)
- Added `breakTime` (nullable)
- Added `overtimeApproved` (default: false)
- Added `swapRequested` (default: false)

#### New Models

**ShiftPattern**:
- Stores reusable shift templates
- Industry-specific patterns
- Staff requirements and constraints

**ScheduleTemplate**:
- Industry-specific scheduling templates
- Weekly/monthly pattern definitions
- Coverage requirements

**EmployeeConstraints**:
- Individual employee scheduling constraints
- Time preferences and restrictions
- Work pattern limitations

**GenerationLog**:
- Tracks auto-generation history
- Performance metrics and statistics
- Error tracking and debugging info

**EmployeeCertification**:
- Employee certification tracking
- Expiry date management
- Verification status

### 3. Migration Execution Plan

#### Phase 1: Schema Migration
```bash
# Generate migration
npx prisma db push --preview-feature

# Or generate a formal migration
npx prisma migrate dev --name enhanced-scheduling
```

#### Phase 2: Data Population
```bash
# Run updated seed file
npm run seed
```

#### Phase 3: Verification
```bash
# Verify schema
npx prisma generate

# Test database connections
npx prisma db pull
```

### 4. Rollback Strategy

If issues arise, rollback can be performed by:

1. **Remove New Tables**: Drop the new tables if they cause issues
```sql
DROP TABLE IF EXISTS employee_certifications;
DROP TABLE IF EXISTS generation_logs;
DROP TABLE IF EXISTS employee_constraints;
DROP TABLE IF EXISTS schedule_templates;
DROP TABLE IF EXISTS shift_patterns;
```

2. **Remove New Columns**: Remove added columns from existing tables
```sql
-- Employee table rollback
ALTER TABLE employees 
DROP COLUMN weeklyHoursTarget,
DROP COLUMN maxDailyHours,
DROP COLUMN minDailyHours,
DROP COLUMN maxConsecutiveDays,
DROP COLUMN minRestHours,
DROP COLUMN isActive,
DROP COLUMN employeeType,
DROP COLUMN seniorityLevel;

-- Similar for Company and Schedule tables
```

3. **Restore Original Schema**: Use git to restore previous schema.prisma

### 5. Testing Strategy

#### Pre-Migration Tests
- Backup current database
- Test existing functionality
- Document current data state

#### Post-Migration Tests
- Verify all existing data intact
- Test new model relationships
- Validate seed data creation
- Test API endpoints (if any exist)

#### Performance Tests
- Query performance with new indexes
- Load testing with additional tables
- Memory usage validation

### 6. Risk Assessment

#### Low Risk
- All changes are additive
- Default values prevent data issues
- Foreign key constraints use SetNull

#### Medium Risk
- Increased database size
- Query complexity may increase
- New indexes may affect performance

#### Mitigation
- Monitor database performance
- Regular backups before migration
- Staged deployment approach

### 7. Post-Migration Tasks

1. **Update Documentation**
   - API documentation
   - Database schema docs
   - Developer guides

2. **Monitor Performance**
   - Query execution times
   - Database size growth
   - Index effectiveness

3. **User Training**
   - New features documentation
   - Admin interface updates
   - Employee constraint setup

## Implementation Commands

```bash
# 1. Backup current database (production)
mysqldump -u username -p database_name > backup_$(date +%Y%m%d).sql

# 2. Apply migration
cd /home/pabang/myapp/scheduleAuto/backend
npx prisma db push

# 3. Update seed data
node prisma/seed.js

# 4. Generate new Prisma client
npx prisma generate

# 5. Verify migration
npx prisma db pull --print
```

## Expected Benefits

1. **Enhanced Scheduling**: Advanced auto-generation with templates
2. **Better Constraints**: Individual employee preferences and limits
3. **Audit Trail**: Complete tracking of schedule generation
4. **Scalability**: Support for different industries and company sizes
5. **Compliance**: Support for union rules and legal requirements
6. **Analytics**: Performance metrics and optimization data